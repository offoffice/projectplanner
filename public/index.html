app.get("/load/:id", async (req, res) => {
  const projectId = req.params.id;
  try {
    const [projectRows] = await pool.query(
      "SELECT * FROM projects WHERE id = ?",
      [projectId]
    );
    const [taskRows] = await pool.query(
      "SELECT * FROM tasks WHERE project_id = ? ORDER BY start ASC",
      [projectId]
    );

    console.log("LOAD projectId=", projectId);
    console.log("DB projectRows:", projectRows);
    console.log("DB taskRows:", taskRows);

    // Fallback: Wenn keine Tasks in der DB sind, liefere Testdaten zurück,
    // damit das Frontend sofort etwas anzeigen kann.
    if (!taskRows || taskRows.length === 0) {
      console.log("Keine Tasks gefunden. Sende Testdaten zurück.");
      return res.json({
        project: projectRows[0] || {
          kunde: "Demo-Kunde",
          titel: "Demo-Projekt",
          datum: new Date(),
          off_office: "Off Office",
          notizen: "Fallback-Daten"
        },
        tasks: [
          { name: "Videoshooting", category: "Produktion", start: "2023-08-24", end: "2023-08-25", responsible: "Max Mustermann" },
          { name: "Editing Videoshooting", category: "Produktion", start: "2023-08-26", end: "2023-09-05", responsible: "Max Mustermann" },
          { name: "Programmierstart", category: "Entwicklung", start: "2023-09-15", end: "2023-10-10", responsible: "Anna Müller" },
          { name: "Launch", category: "Launch", start: "2023-10-15", end: "2023-10-15", responsible: "Projektteam" }
        ]
      });
    }

    // Normale Antwort mit DB-Daten
    res.json({
      project: projectRows[0] || null,
      tasks: taskRows
    });
  } catch (err) {
    console.error("Fehler in /load/:id", err);
    res.status(500).json({ error: "Fehler beim Laden" });
  }
});

// Seed-Route: legt Demo-Tasks für ein Projekt an, wenn noch keine existieren.
// Aufruf: GET /seed oder /seed/:id   (Default-Projekt-ID = 1)
app.get("/seed/:id?", async (req, res) => {
  const projectId = req.params.id ? Number(req.params.id) : 1;
  try {
    const [existing] = await pool.query(
      "SELECT COUNT(*) AS cnt FROM tasks WHERE project_id = ?",
      [projectId]
    );
    if (existing[0].cnt > 0) {
      return res.json({ ok: true, seeded: false, message: "Es existieren bereits Tasks für dieses Projekt." });
    }

    const demoTasks = [
      ["Videoshooting", "Produktion", "2023-08-24", "2023-08-25", "Max Mustermann", ""],
      ["Editing Videoshooting", "Produktion", "2023-08-26", "2023-09-05", "Max Mustermann", ""],
      ["Programmierstart", "Entwicklung", "2023-09-15", "2023-10-10", "Anna Müller", ""],
      ["Launch", "Launch", "2023-10-15", "2023-10-15", "Projektteam", ""]
    ];

    for (const t of demoTasks) {
      await pool.query(
        "INSERT INTO tasks (project_id, name, category, start, end_date, responsible, dependencies) VALUES (?, ?, ?, ?, ?, ?, ?)",
        [projectId, t[0], t[1], t[2], t[3], t[4], t[5]]
      );
    }

    return res.json({ ok: true, seeded: true, count: demoTasks.length, projectId });
  } catch (err) {
    console.error("Fehler in /seed", err);
    res.status(500).json({ ok: false, error: "Fehler beim Seeden" });
  }
});