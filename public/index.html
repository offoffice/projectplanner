<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Projekt-Zeitplan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- vis-timeline (jsDelivr pinned versions + Moment locale) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css">
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment-with-locales.min.js"></script>
  <script>moment.locale('de');</script>
  <script src="https://cdn.jsdelivr.net/npm/vis-data@7.1.2/peer/umd/vis-data.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
  <style>
    :root { --bg:#fff; --fg:#111; --muted:#777; --grid:#ddd; --zebra:#f6f6f6; --accent:#111; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Helvetica,Arial,sans-serif;}
    .wrap{max-width:1400px;margin:0 auto;padding:32px;}
    .head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;}
    .left{display:flex;gap:16px;flex-wrap:wrap}
    .cell{min-width:160px}
    .cell .val{font-size:14px;letter-spacing:.2px}
    .right{min-width:160px;text-align:right}
    .right .val{font-size:14px}
    .title{font-size:20px;margin:0 0 8px 0;letter-spacing:.2px}
    .frame{position:relative; width:100%; aspect-ratio:16/9; min-height:560px; border:1px solid #eee; background:#fff; overflow:hidden; border-radius:12px; padding:16px;}
    #timeline{position:absolute; inset:64px 16px 16px 16px; z-index:2;}
    .bands{position:absolute; left:16px; right:16px; top:16px; height:40px; display:grid; grid-template-rows:20px 20px;}
    .bands .row{display:flex;}
    .bands .cell{flex:0 0 auto; text-align:center; font-size:12px; color:var(--muted);}
    .today{position:absolute; top:0; bottom:0; width:1px; background:#000; opacity:.7;}
    .zebra{pointer-events:none; position:absolute; left:16px; right:16px; bottom:16px; top:64px; z-index:1;}
    .legend{display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;}
    .dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px}
    .toolbar{display:flex; gap:8px; align-items:center; margin:12px 0 4px}
    input,button{font:inherit;border:1px solid #ddd;border-radius:8px;padding:6px 10px}
    button{cursor:pointer;background:#111;color:#fff;border-color:#111}
    button.secondary{background:#fff;color:#111}
    .vis-item.weekend { background: #f5f5f5; border-color: #f5f5f5; }
    .vis-time-axis .vis-grid.vis-saturday,
    .vis-time-axis .vis-grid.vis-sunday { background: #fafafa; }
    .vis-time-axis .vis-grid.vis-major { border-color: #e6e6e6; }
    .vis-time-axis .vis-grid.vis-minor { border-color: #f0f0f0; }
    .vis-item.vis-box { border-radius:10px; border-width:1px; }

    /* stronger vertical grid for weeks/months */
    .vis-time-axis .vis-grid.vis-major { border-color: #cfd4d9; }
    .vis-time-axis .vis-grid.vis-minor { border-color: #e6e9ec; }
    .vis-time-axis .vis-text { color:#666; font-size:12px; }

    /* weekend background already present; today line clearer */
    .today { width:2px; background:#e53935; opacity:1; }
    .today::after {
      content:"Heute";
      position:absolute; top:-18px; left:-16px; font-size:11px; color:#e53935;
    }

    /* task appearance – no outlines, soft filled background */
    .vis-item.task { border:none !important; border-radius:8px !important; }
    .vis-item.task .vis-item-content { padding:6px 8px; line-height:1.2; white-space:nowrap; overflow:visible; }
    .task-title { font-weight:600; }
    .task-resp { color:#666; font-size:11px; }

    /* floating action button + modal */
    .fab {
      position: fixed; right: 24px; bottom: 24px;
      background:#111; color:#fff; border:0; border-radius:20px; padding:10px 14px; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
    }
    .modal.hidden { display:none; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.3); display:flex; align-items:flex-end; justify-content:flex-end; }
    .modal-card {
      width:360px; background:#fff; border-radius:12px; margin:16px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,.16);
      border:1px solid #e8eaee;
    }
    .modal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .modal-title { font-weight:600; }
    .modal-close { background:#fff; border:1px solid #ddd; border-radius:8px; width:28px; height:28px; cursor:pointer; }
    .form-row { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin:10px 0; }
    .form-row label { grid-column:1 / -1; font-size:12px; color:#555; }
    .form-row input { border:1px solid #ddd; border-radius:8px; padding:6px 8px; }
    .form-row button { border:1px solid #111; background:#111; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    hr { border:none; border-top:1px solid #eee; margin:10px 0; }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Kopfzeile -->
  <div class="head">
    <div class="left">
      <div class="cell"><div class="val" id="vKunde">Kunde</div></div>
      <div class="cell"><div class="val" id="vTitel">Titel</div></div>
      <div class="cell"><div class="val"><span>Stand: </span><span id="vDatum">Datum</span></div></div>
    </div>
    <div class="right">
      <div class="val">Off Office</div>
    </div>
  </div>

  <!-- Floating Options Button -->
  <button id="btnOptions" class="fab">Options</button>

  <!-- Options Modal -->
  <div id="optionsModal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">Optionen</div>
        <button id="modalClose" class="modal-close">×</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>Projekt-Titel laden</label>
          <input id="inpTitle" type="text" placeholder="z.B. Website-Relaunch" />
          <button id="btnLoadByTitle">Laden</button>
        </div>
        <div class="form-row">
          <label>Projekt-ID laden (Fallback)</label>
          <input id="inpId" type="number" min="1" placeholder="1" />
          <button id="btnLoadById">Laden</button>
        </div>
        <hr />
        <div class="form-row">
          <label>Auf Projektjahr angleichen</label>
          <input id="inpYear" type="number" min="2000" max="2100" placeholder="z.B. 2025" />
          <button id="btnShiftYear">Verschieben</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.hostname === "localhost"
  ? "http://localhost:5001"
  : window.location.origin;
const MS_DAY = 24*60*60*1000;
function toDate(d){ return (d instanceof Date) ? d : new Date(d); }
function fmt(d){ const x = toDate(d); return x.toLocaleDateString('de-DE'); }
function startOfDay(d){ d = toDate(d); d.setHours(0,0,0,0); return d; }

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}
function rangeDays(a,b){ const out=[]; let t=startOfDay(a).getTime(); const end=startOfDay(b).getTime(); while(t<=end){ out.push(new Date(t)); t+=MS_DAY; } return out; }
function monthLabel(d){ return d.toLocaleDateString('de-DE', { month:'long', year:'numeric' }); }
function buildColorMap(categories){ const palette = ["#111","#555","#999","#c0c0c0","#7f7f7f"]; const map={}; categories.forEach((c,i)=>map[c]=palette[i%palette.length]); return map; }

function weekendItems(from, to){
  const out=[];
  let cur = startOfDay(from);
  while(cur<=to){
    const day = cur.getDay();
    if(day===6){
      const sat = new Date(cur);
      const sunEnd = new Date(cur.getTime()+2*MS_DAY);
      out.push({ id:'we-'+sat.toISOString(), start:sat, end:sunEnd, type:'background', className:'weekend' });
    }
    cur = new Date(cur.getTime()+MS_DAY);
  }
  return out;
}
function drawZebra(){
  const el = document.getElementById('zebra');
  el.style.background = "repeating-linear-gradient(0deg, rgba(0,0,0,0.04), rgba(0,0,0,0.04) 40px, transparent 40px, transparent 80px)";
}
function buildBands(containerIdMonths, containerIdWeeks, from, to){
  const monthsEl = document.getElementById(containerIdMonths);
  const weeksEl = document.getElementById(containerIdWeeks);
  monthsEl.innerHTML = ""; weeksEl.innerHTML = "";
  let cursor = new Date(from.getFullYear(), from.getMonth(), 1);
  while(cursor <= to){
    const nextMonth = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1);
    const cell = document.createElement('div');
    cell.className="cell";
    const width = Math.max(60, (nextMonth - cursor) / (to - from) * (monthsEl.parentElement.clientWidth));
    cell.style.width = width + "px";
    cell.textContent = monthLabel(cursor);
    monthsEl.appendChild(cell);
    cursor = nextMonth;
  }
  let day = new Date(from);
  day.setDate(day.getDate() - ((day.getDay()+6)%7));
  while(day<=to){
    const wk = getISOWeek(day);
    const wkEnd = new Date(day.getTime()+6*MS_DAY);
    const cell = document.createElement('div');
    cell.className="cell";
    const end = (wkEnd<to)? wkEnd : to;
    const width = Math.max(40, (end - day + MS_DAY) / (to - from) * (weeksEl.parentElement.clientWidth));
    cell.style.width = width + "px";
    cell.textContent = `W${wk} · ${day.getDate()}–${end.getDate()}`;
    weeksEl.appendChild(cell);
    day = new Date(day.getTime()+7*MS_DAY);
  }
}
function positionToday(from, to){
  const el = document.getElementById('todayLine');
  const frame = document.querySelector('.frame');
  const left = 16, right = 16;
  const usable = frame.clientWidth - left - right;
  const now = new Date();
  const clamped = Math.min(Math.max(now.getTime(), from.getTime()), to.getTime());
  const px = left + ((clamped - from) / (to - from)) * usable;
  el.style.left = px + "px"; el.style.display = "block";
}

let timeline;

const CATEGORY_COLORS = ["#5B8DEF","#52C41A","#FAAD14","#EB5757","#8F65D0","#00BFB3","#FF7A45"];
function colorFor(cat){
  const i = Math.abs((cat||"").split("").reduce((a,c)=>a+c.charCodeAt(0),0)) % CATEGORY_COLORS.length;
  return CATEGORY_COLORS[i];
}

async function renderData(data){
  document.getElementById('vKunde').textContent = data.project?.kunde || "";
  document.getElementById('vTitel').textContent = data.project?.titel || "";
  document.getElementById('vDatum').textContent = data.project?.datum ? fmt(data.project.datum) : "";
  const starts = data.tasks.map(t=>new Date(t.start));
  const ends = data.tasks.map(t=>new Date(t.end_date || t.end || t.start));
  if(starts.length===0){ return; }
  const min = new Date(Math.min.apply(null, starts));
  const max = new Date(Math.max.apply(null, ends));
  const from = new Date(min.getTime() - 7*MS_DAY);
  const to = new Date(max.getTime() + 7*MS_DAY);
  const items = new vis.DataSet();
  data.tasks.forEach((t,i)=>{
    items.add({
      id: t.id || "t"+i,
      content: `<div class="task-title">${t.name}</div><div class="task-resp">${t.responsible||""}</div>`,
      start: t.start,
      end: t.end_date || t.end || t.start,
      className: "task",
      style: `background:${colorFor(t.category)}1f;`
    });
  });
  weekendItems(from,to).forEach(w=>items.add(w));
  const container = document.getElementById('timeline');
  if(timeline){ timeline.destroy(); }
  timeline = new vis.Timeline(container, items, {
    stack: true, orientation: 'top', showMajorLabels: true,
    zoomMin: MS_DAY*2, zoomMax: MS_DAY*365,
    start: from, end: to, min: from, max: new Date(to.getTime()+MS_DAY),
    selectable: false, margin: { item: 10, axis: 8 }, height:'100%'
  });
  timeline.redraw(); timeline.fit();
  buildBands('months','weeks',from,to); drawZebra(); positionToday(from,to);
  const categories = Array.from(new Set(data.tasks.map(t=>t.category))).filter(Boolean);
  const legend = document.getElementById('legend'); legend.innerHTML = "";
  categories.forEach(c=>{
    const span = document.createElement('span');
    span.innerHTML = `<span class="dot" style="background:${colorFor(c)}"></span>${c}`;
    legend.appendChild(span);
  });
}

async function loadProject(id){
  const res = await fetch(`${API_BASE}/load/${id}`);
  if(!res.ok){ alert("Projekt nicht gefunden"); return; }
  const data = await res.json();
  console.log("DATA", data);
  await renderData(data);
}

// Modal / Options
const modal = document.getElementById('optionsModal');
document.getElementById('btnOptions').addEventListener('click', ()=> modal.classList.remove('hidden'));
document.getElementById('modalClose').addEventListener('click', ()=> modal.classList.add('hidden'));
document.getElementById('btnLoadById').addEventListener('click', async ()=>{
  const id = Number(document.getElementById('inpId').value||"1");
  await loadProject(id);
  modal.classList.add('hidden');
});
document.getElementById('btnLoadByTitle').addEventListener('click', async ()=>{
  const title = (document.getElementById('inpTitle').value||"").trim();
  if(!title){ alert("Bitte Projekttitel eingeben."); return; }
  const res = await fetch(`${API_BASE}/loadByTitle?title=${encodeURIComponent(title)}`);
  if(!res.ok){ alert("Projekt nicht gefunden"); return; }
  const data = await res.json();
  await renderData(data);
  modal.classList.add('hidden');
});
document.getElementById('btnShiftYear').addEventListener('click', async ()=>{
  const id = Number(document.getElementById('inpId').value||"1");
  const year = Number(document.getElementById('inpYear').value||new Date().getFullYear());
  const res = await fetch(`${API_BASE}/shiftYear`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ projectId:id, year })
  });
  const ok = res.ok;
  await loadProject(id);
  modal.classList.add('hidden');
  if(!ok) alert("Verschieben fehlgeschlagen");
});

loadProject(1);
</script>
</body>
</html>